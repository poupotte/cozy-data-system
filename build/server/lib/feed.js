// Generated by CoffeeScript 1.8.0
var Client, Feed, S, client, fs, setCouchCredentials,
  __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

fs = require('fs');

S = require('string');

Client = require('request-json').JsonClient;

client = null;

setCouchCredentials = function() {
  var data, lines;
  if (process.env.NODE_ENV === 'production') {
    data = fs.readFileSync('/etc/cozy/couchdb.login');
    lines = S(data.toString('utf8')).lines();
    return client.setBasicAuth(lines[0], lines[1]);
  }
};

module.exports = Feed = (function() {
  var deleted_ids;

  Feed.prototype.db = void 0;

  Feed.prototype.feed = void 0;

  Feed.prototype.axonSock = void 0;

  deleted_ids = {};

  function Feed() {
    this._onChange = __bind(this._onChange, this);
    this.publish = __bind(this.publish, this);
    this.logger = require('printit')({
      date: true,
      prefix: 'helper/db_feed'
    });
  }

  Feed.prototype.initialize = function(server) {
    this.startPublishingToAxon();
    return server.on('close', (function(_this) {
      return function() {
        _this.stopListening();
        if (_this.axonSock != null) {
          return _this.axonSock.close();
        }
      };
    })(this));
  };

  Feed.prototype.startPublishingToAxon = function() {
    var axon, axonPort;
    axon = require('axon');
    this.axonSock = axon.socket('pub-emitter');
    axonPort = parseInt(process.env.AXON_PORT || 9105);
    this.axonSock.bind(axonPort);
    this.logger.info('Pub server started');
    this.axonSock.sock.on('connect', (function(_this) {
      return function() {
        return _this.logger.info("An application connected to the change feeds");
      };
    })(this));
    return this.axonSock.sock.on('message', (function(_this) {
      return function(event, id) {
        return _this._publish(event.toString(), id.toString());
      };
    })(this));
  };

  Feed.prototype.startListening = function(db) {
    var couchUrl;
    this.stopListening();
    couchUrl = "http://" + db.connection.host + ":" + db.connection.port + "/";
    client = new Client(couchUrl);
    setCouchCredentials();
    this.feed = db.changes({
      since: 'now'
    });
    this.feed.on('change', this._onChange);
    this.feed.on('error', (function(_this) {
      return function(err) {
        _this.logger.error("Error occured with feed : " + err.stack);
        return _this.stopListening();
      };
    })(this));
    return this.db = db;
  };

  Feed.prototype.stopListening = function() {
    if (this.feed != null) {
      this.feed.stop();
      this.feed.removeAllListeners('change');
      this.feed = null;
    }
    if (this.db != null) {
      return this.db = null;
    }
  };

  Feed.prototype.publish = function(event, id) {
    return this._publish(event, id);
  };

  Feed.prototype._publish = function(event, id) {
    this.logger.info("Publishing " + event + " " + id);
    if (this.axonSock != null) {
      return this.axonSock.emit(event, id);
    }
  };

  Feed.prototype._onChange = function(change) {
    var dbName, isCreation, operation;
    if (change.deleted) {
      dbName = process.env.DB_NAME || 'cozy';
      return client.get("/" + dbName + "/" + change.id + "?revs_info=true&open_revs=all", (function(_this) {
        return function(err, res, doc) {
          var binary, _ref, _ref1, _ref2, _ref3;
          if ((doc != null ? (_ref = doc[0]) != null ? (_ref1 = _ref.ok) != null ? _ref1.docType : void 0 : void 0 : void 0) != null) {
            doc = doc[0].ok;
            _this._publish("" + (doc.docType.toLowerCase()) + ".delete", change.id);
            if (((_ref2 = doc.binary) != null ? (_ref3 = _ref2.file) != null ? _ref3.id : void 0 : void 0) != null) {
              binary = doc.binary.file.id;
              return _this.db.get(binary, function(err, doc) {
                if (err) {
                  return;
                }
                if (doc) {
                  return _this.db.remove(binary, binary._rev, function(err, doc) {
                    return _this._publish("binary.delete", binary);
                  });
                }
              });
            }
          }
        };
      })(this));
    } else {
      isCreation = change.changes[0].rev.split('-')[0] === '1';
      operation = isCreation ? 'create' : 'update';
      return this.db.get(change.id, (function(_this) {
        return function(err, doc) {
          var doctype, _ref;
          if (err != null) {
            _this.logger.error(err);
          }
          doctype = doc != null ? (_ref = doc.docType) != null ? _ref.toLowerCase() : void 0 : void 0;
          if (doctype) {
            return _this._publish("" + doctype + "." + operation, doc._id);
          }
        };
      })(this));
    }
  };

  return Feed;

})();

module.exports = new Feed();
