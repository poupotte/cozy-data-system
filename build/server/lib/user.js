// Generated by CoffeeScript 1.8.0
var User, db;

db = require('../helpers/db_connect_helper').db_connect();

module.exports = User = (function() {
  function User() {}

  User.prototype.initAllView = function(callback) {
    return db.get("_design/user", function(err, res) {
      var design_doc, map;
      map = "function(doc) {\n    if(doc.docType.toLowerCase() === \"user\") {\n        return emit(doc._id, doc);\n    }\n}";
      design_doc = {
        all: {
          map: map
        }
      };
      if (err && err.error === 'not_found') {
        return db.save("_design/user", design_doc, function(err, res) {
          if (err) {
            return callback(err);
          } else {
            return callback(null);
          }
        });
      } else if (res.all == null) {
        return db.merge("_design/user", design_doc, function(err, res) {
          if (err) {
            return callback(err);
          } else {
            return callback(null);
          }
        });
      } else {
        return callback(null);
      }
    });
  };

  User.prototype.getUser = function(callback) {
    return this.initAllView(function(err) {
      if (err) {
        return callback(err);
      } else {
        return db.view('user/all', (function(_this) {
          return function(err, res) {
            if (err) {
              return callback(err);
            } else {
              if (res.length > 0) {
                return callback(null, res[0].value);
              } else {
                return callback(new Error("No user found"));
              }
            }
          };
        })(this));
      }
    });
  };

  return User;

})();
